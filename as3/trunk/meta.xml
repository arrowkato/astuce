<?xml version="1.0" encoding="UTF-8"?>

<project name="astuce" default="main" basedir=".">
    
    <target name="clean">
        <delete dir="${basedir}/${release.dir}" />
        <delete dir="${basedir}/${asdoc.output}" />
    </target>
    
    <target name="before">
        <mkdir dir="${basedir}/${release.dir}" />
        <mkdir dir="${basedir}/${asdoc.output}" />
    </target>
    
    <target name="main" depends="clean,before,build-doc,build-abc,build-abc-test,build-swc,build-swc-SA,after">
        
    </target>
    
    <target name="build-doc">
        <!--         templates-path="${basedir}/${asdoc.template}" -->
        <asdoc
        output="${basedir}/${asdoc.output}"
        target-player="${local.flashplayerversion}"
        main-title="${asdoc.main.title}"
        footer="${asdoc.footer}"
        window-title="${asdoc.window.title}"
        left-frameset-width="300"
        failonerror="true"
        >
            <load-config filename="${FLEX_HOME}/frameworks/flex-config.xml"/>
            <load-config filename="${basedir}/build/config.xml"/>
            <keep-xml>true</keep-xml>
            <doc-sources path-element="${basedir}/${project.src}"/>
            <verbose-stacktraces>true</verbose-stacktraces>
            <source-path path-element="${basedir}/${project.src}" />
            <external-library-path dir="${basedir}/${project.lib-swc}/" append="true">
               <include name="logd.swc"/>
               <include name="core.swc"/>
               <include name="system.terminals.swc"/>
            </external-library-path>
            <exclude-sources path-element="${basedir}/${project.src}/astuce.as" />
            <exclude-sources path-element="${basedir}/${project.src}/astuce-test.as" />
            <exclude-sources path-element="${basedir}/${project.src}/astuce-testrunner.as" />
            <packages.package name="buRRRn.ASTUce" description="The ASTUce framework" />
            <packages.package name="buRRRn.ASTUce.extensions" description="addons to the framework" />
            <packages.package name="buRRRn.ASTUce.framework" description="the framework itself" />
            <packages.package name="buRRRn.ASTUce.mocks" description="mock library - alpha" />
            <packages.package name="buRRRn.ASTUce.runner" description="test runners" />
            <packages.package name="buRRRn.ASTUce.ui" description="user interface" />
        </asdoc>
        
    </target>
    
    <target name="build-abc">
        
        <java
            dir="${basedir}"
            jar="${ASC}"
            fork="true"
            failonerror="true"
        >
            <arg line="-AS3 -strict -optimize"/>
            <arg line="-config LOG::P=true -config API::REDTAMARIN=true -config API::FLASH=false"/>
            <arg line="-import ${builtin} -import ${toplevel} -import ${logd} -import ${core} -import ${system.terminals}"/>
            <arg line="src/${project.as}"/>
        </java>
        
        <move file="${basedir}/src/${project.abc}" todir="${basedir}/${release.dir}" />

    </target>
    
    <target name="build-abc-test">
        
        <java
            dir="${basedir}"
            jar="${ASC}"
            fork="true"
            failonerror="true"
        >
            <arg line="-AS3 -strict -optimize"/>
            <arg line="-config LOG::P=true -config API::REDTAMARIN=true -config API::FLASH=false"/>
            <arg line="-import ${builtin} -import ${toplevel} -import ${core} -import ${system.terminals}"/>
            <arg line="-import ${basedir}/${release.dir}/${project.abc}"/>
            <arg line="src/${project.name}-test.as"/>
        </java>
        
        <move file="${basedir}/src/${project.abc-test}" todir="${basedir}/${release.dir}" />

    </target>
    
    <target name="build-swc">
        <!-- 
            generate a SWC component
            this SWC is compatible Flash CS3/CS4 and Flex 3/4
         -->
        <compc
            output="${basedir}/${release.dir}/${project.swc}"
            target-player="${local.flashplayerversion}"
        >
            <load-config filename="${FLEX_HOME}/frameworks/flex-config.xml"/>
            <load-config filename="${basedir}/build/config.xml"/>
            <namespace uri="${project.namespace}" manifest="${basedir}/${project.manifest}" />
            <include-namespaces uri="${project.namespace}" />
            <strict>true</strict>
            <optimize>true</optimize>
            <warnings>true</warnings>
            <verbose-stacktraces>false</verbose-stacktraces>
            <compute-digest>false</compute-digest>
            <external-library-path dir="${basedir}/${project.lib-swc}/" append="true">
               <include name="logd.swc"/>
               <include name="core.swc"/>
               <include name="system.terminals.swc"/>
            </external-library-path>
            <source-path path-element="${basedir}/${project.src}" />
            <include-sources dir="${basedir}/${project.src}/buRRRn/ASTUce" includes="**/*.as" />
            <metadata date="${TODAY}" title="${project.name}">
                <publisher name="${project.publisher}" />
                <creator name="${project.creator}" />
            </metadata>
        </compc>
    </target>
    
    <target name="build-swc-SA">
        <!-- 
            generate a SWC component
            this SWC is compatible Flash CS3/CS4 and Flex 3/4
         -->
        <compc
            output="${basedir}/${release.dir}/${project.swc-SA}"
            target-player="${local.flashplayerversion}"
        >
            <load-config filename="${FLEX_HOME}/frameworks/flex-config.xml"/>
            <load-config filename="${basedir}/build/config.xml"/>
            <namespace uri="${project.namespace}" manifest="${basedir}/${project.manifest}" />
            <include-namespaces uri="${project.namespace}" />
            <strict>true</strict>
            <optimize>true</optimize>
            <warnings>true</warnings>
            <verbose-stacktraces>false</verbose-stacktraces>
            <compute-digest>false</compute-digest>
            <library-path dir="${basedir}/${project.lib-swc}/" append="true">
               <include name="logd.swc"/>
               <include name="core.swc"/>
               <include name="system.terminals.swc"/>
            </library-path>
            <source-path path-element="${basedir}/${project.src}" />
            <include-sources dir="${basedir}/${project.src}/buRRRn/ASTUce" includes="**/*.as" />
            <metadata date="${TODAY}" title="${project.name}">
                <publisher name="${project.publisher}" />
                <creator name="${project.creator}" />
            </metadata>
        </compc>
    </target>
    
    <target name="after">
        
    </target>
    
</project>